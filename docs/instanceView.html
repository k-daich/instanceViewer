<!DOCTYPE html>
<html>

<head>
    <title>InstanceView</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <script type="text/javascript" src="js/data.js"></script> -->
    <link rel="stylesheet" type="text/css" href="css/movableColumn.css">
    <link rel="stylesheet" type="text/css" href="css/lightUpCross.css">
    <style>
        :root {
            --baseColor: #363636; /* this color is dynamic set by javascript */
            --baseColor_bg: #dddddd; /* this color is dynamic set by javascript */
            --rightUpColor: #e6b2c0; /* this color is dynamic set by javascript */
        }

        html {
            color: var(--baseColor);
            background: var(--baseColor_bg);
        }

        .dynamicTable {
            border-collapse: separate;
            border-spacing: 3px;
            /*table-layout: fixed;*/
            --varTest1 : 1;
            --varTest : "var(--column" + var(--varTest1) + "_x)";
            --column1_x: 100px;
            --column2_x: 200px;
            /*width: 100%;*/
        }

        /* 動的テーブルの子孫thタグのスタイル指定 */
        /* 動的テーブルの子孫tdタグのスタイル指定 */
        .dynamicTable th,
        .dynamicTable td {
            position : relative;
            top : 0px;
            left : 0px;
            border-style: solid;
            border-radius: 3px;
            text-align: center;
        }

/*        .dynamicTable thead>tr {
            position : fixed;
            z-index:10;
        }*/

        /* 動的テーブルの子孫thタグのスタイル指定 */
        .dynamicTable th {
            background-color: #c79852;
            color: white;
            border: solid 1px #927141;
            padding: 3px 0;
            font-size: 1.1rem;
            line-height: 1.2rem;
        }

        /* No列 */
        th.no {
            width : 30px;
        }

        th.column1 {
            left : var(--column1_x);
            transition : 2s;
        }

        th.column2 {
            left : calc(var(--column1_x) + var(--column2_x));
            transition : 2s;
        }

        /* 動的テーブルの子孫trタグのスタイル指定 */
        .dynamicTable tr {
            background-color: #e4d4bc;
        }
        /* 動的テーブルの子孫trタグのスタイル指定(偶数行) */
        .dynamicTable tr:nth-of-type(2n) {
            background-color: #eaeae0;
        }

        /* 動的テーブルの子孫tdタグのスタイル指定 */
        .dynamicTable td {
            border: solid 1px #af9d85;
            padding: 2px 0;
            font-size: 0.9rem;
            width : var(--varTest);
        }

        .columnTbl_No {
            position : relative;
            left : 0;
            top : 0;
        }
        .icon-column {
            position: relative;
            width: 15px;
            height: 15px;
            background: #bbb;
            border-radius: 50%;
            text-align: center;
            margin: auto;
        }

        .icon-minus::before {
            position: absolute;
            top: calc(50% - 1px);
            left: 50%;
            content: '';
            display: inline-block;
            width: 60%;
            height: 10%;
            transform: translateX(-50%);
        }

        .icon-column.icon-minus::before {
            border-top: 2px solid #fff;
        }

        .icon-menu.icon-minus::before {
            border-top: 4px solid #333;
        }

        .icon-menu {
            position : fixed;
            width: 50px;
            height: 50px;
            right : 10px;
            bottom : 10px;
            background: #ccc;
            border-radius: 50%;
            margin: auto;
            border: 5px solid #333;
            z-index: 20;
        }

        .icon-plus::after {
            position: absolute;
            top: 50%;
            left: 50%;
            content: '';
            display: inline-block;
            width: 50%;
            height: 50%;
            border-top: 4px solid #333;
            transform: translateX(-50%);
        }

        .icon-plus:after {
            top: 25%;
            left: 0;
            transform: rotate(90deg);
        }

        .menu-window {
            position : fixed;
            right :20px;
            bottom :20px;
            width : 20vh;
            height : 150px;
            color : #fff;
            background: #000;
            border-radius: 7px;
            z-index: 10;
            transition : 1.2s;
        }

        .hidden, .hidden * {
            /*display: none;*/
            opacity : 0 !important;
            height : 5px !important;
            width : 0 !important;
            font-size : 0 !important;
            transition : 1.2s !important;
        }

    </style>
    <div id="style_writtenByJavascript">
    </div>
</head>

<body>
    <main>
        <div id="dynamicTable" class="dynamicTable">
        </div>
        <div id="menu-button" class="icon-menu icon-plus icon-minus"></div>
        <div id="menu-window" class="menu-window hidden">
            <ul id="unvealColumnList">
            </ul>
        </div>
    </main>
    <script type="text/javascript">
    const JSFILE_DATA = "js/data.js";
    const JSFILE_MOVABLE_COLMN = "js/movableColumn.js";
    const JSFILE_LIGHTUP_CROSS = "js/lightUpCross.js";
    const JSFILE_HIDE_COLUMN = "js/hideColumn.js";
    const JSFILE_UNVEAL_COLUMN = "js/menu_unvealCoulumn.js";

    /* 定数定義 */
    const STORAGE_KEY_HIDDEN_COULUMNS = 'hiddenColumns';
    const STORAGE_KEY_TBL_KEYS_DISP_ORDER = 'tableKeysForDispOrder';

    // data.js読み込み完了後にdynamicTableを生成する
    loadScript(JSFILE_DATA, function() {
        var INSTANCES_INFO = INSTANCES_INFO_INTERNAL;

        var tableKeysForDispOrder = decideTableKeysDispOrder();
        var hiddenColumns = getHiddenColumnsArrayFrmLocStrg();

        // createTableHeaderRowHtml(tableKeysForDispOrder, hiddenColumns);
        // createTableDataRowHtml(tableKeysForDispOrder, hiddenColumns);
        buildTable();

        // dynamicTableにイベントリスナーを付与するため、必ずdynamicTable生成完了後に実施する必要がある
        loadScript(JSFILE_MOVABLE_COLMN, function() {
            // this function is in movableColumn.js
            moveColumnEventListenr();
        });

        // dynamicTableにイベントリスナーを付与するため、必ずdynamicTable生成完了後に実施する必要がある
        loadScript(JSFILE_LIGHTUP_CROSS, function() {
            // this function is in lightUpCross.js
            lightUpCrossEventListener();
        });

        // dynamicTableにイベントリスナーを付与するため、必ずdynamicTable生成完了後に実施する必要がある
        loadScript(JSFILE_HIDE_COLUMN, function() {
            // this function is in hideColumn.js
            hideColumnEventListener();
        });

        /**
         * 
         */
        function decideTableKeysDispOrder() {
            var locStrgArray = getLocalStorageAsArray(STORAGE_KEY_TBL_KEYS_DISP_ORDER);

            // localStorageの値が妥当な場合
            if (isCorrectTableKeys(locStrgArray)) {
                // ローカルストレージの値を返す
                return locStrgArray;
            }
            // localStorageの値が妥当でない場合
            else {
                // 現在のデータ値からキー値を取得する
                var tableKeysForDispOrder_current = Object.keys(INSTANCES_INFO[Object.keys(INSTANCES_INFO)[0]]);
                // ローカルストレージを更新する
                localStorage.setItem(STORAGE_KEY_TBL_KEYS_DISP_ORDER, tableKeysForDispOrder_current);
                return tableKeysForDispOrder_current;
            }
        }

        /**
         * テーブルキー配列が妥当か現在の値を元に判定する
         */
        function isCorrectTableKeys(tableKeysForDispOrder) {
            // 現在のキー配列を取得する
            var currentKeys = INSTANCES_INFO[Object.keys(INSTANCES_INFO)[0]];
            // 妥当と判定した回数
            var correctCount = 0;

            // ローカルストレージから取得した配列を元に繰り返し処理
            for (index in tableKeysForDispOrder) {
                // ローカルストレージのキー値が現在のキー配列に存在する場合
                if (tableKeysForDispOrder[index] in currentKeys) {
                    // チェック状態管理用フラグを1つ立てる
                    ++correctCount;
                } else {
                    console.log('[isCorrectTableKeys] false : A');
                    return false;
                }
            }
            // 妥当と判定した回数が現在のキー配列長と一致しない場合
            if (Object.keys(currentKeys).length != correctCount) {
                console.log('[isCorrectTableKeys] false : B');
                return false;
            }
            console.log('[isCorrectTableKeys] true');
            return true;
        }

        function buildTable() {
            var column_index = 0;
            buildFixedTable();
        }

        function buildFixedTable() {
            var tableHtml = '<table><thead class="blank"><tr><th>No</th><th>インスタンス名</th></thead><tbody>';
            var instanceNames = Object.keys(INSTANCES_INFO);

            for (index in instanceNames) {
                logging('tr', '<tr><td>' + index + '</td></tr>');
                tableHtml = tableHtml + '<tr><td>' + index + '</td><td>' + instanceNames[index] + '</td></tr>';
            }

            tableHtml = tableHtml + '</tbody>';
            document.getElementById('dynamicTable').insertAdjacentHTML('beforeend', tableHtml);
        }

        function buildDynamicColumnTable(columnName, column_index) {
            var tableHtml = '<table class="oneColumnTable"><thead><tr><th>' + columnName + '</th></thead><tbody>';

            switch (columnName) {
                case 'No':
                    tableHtml = tableHtml + buildTbody_No();
                    break;
                case 'インスタンス名':
                    tableHtml = tableHtml + buildTbody_InstanceName();
                    break;
                default:
                    tableHtml = tableHtml + buildTbody_DynamicColumn();
                    break;
            }
            tableHtml = tableHtml + '</tbody>';
            document.getElementById('dynamicTable').insertAdjacentHTML('beforeend', tableHtml);
        }

        /**
         * tableのthタグを連想配列データから生成する
         */
        // function createTableHeaderRowHtml(tableKeysForDispOrder, hiddenColumns) {
        //     var index_tblKysFDspOrdr = 0;
        //     // インスタンス名列定義までは固定定義
        //     var thHtml = '<thead><tr><th class="no">No</th><th>インスタンス名</th>';
        //     // 2次元連想配列の内部配列のキー名を繰り返し取得する
        //     for (index in tableKeysForDispOrder) {
        //         var keyName = tableKeysForDispOrder[index];
        //         // thタグを生成する
        //         thHtml = thHtml + '<th class="moveableColumn' + getIfHidden(hiddenColumns, keyName) + '" index_tblKysFDspOrdr="' + index_tblKysFDspOrdr++ + '">' + keyName + '<br/><div class="icon-column icon-minus hidableColumn"></div></th>';
        //     }
        //     // trの閉じタグを追加
        //     var thHtml = thHtml + '</thead></tr>';
        //     document.getElementById('dynamicTable').insertAdjacentHTML(
        //         'afterbegin', thHtml);
        // }

        /**
         * tableのtbodyタグを連想配列データから生成する
         **/
        // function createTableDataRowHtml(tableKeysForDispOrder, hiddenColumns) {
        //     // tdタグの位置を示すオブジェクト
        //     var tdPosition = new Object();
        //     tdPosition.row = 1;
        //     tdPosition.column = 0;
        //     var tbodyHtml = '<tbody>';
        //     // 列「No」に設定する値
        //     var no = 1;

        //     for (outerArrayKey in INSTANCES_INFO) {
        //         // Noとインスタンス名列のtdタグを生成
        //         tbodyHtml = tbodyHtml + '<tr><td id="' + getNextColumnId(tdPosition) + '">' + no++ + '</td><td id="' + getNextColumnId(tdPosition) + '">' + outerArrayKey + '</td>';
        //         for (internalArrayKey in tableKeysForDispOrder) {
        //             var columnName = tableKeysForDispOrder[internalArrayKey];
        //             // 前述以外の列（Noとインスタンス名以外）のtdタグを生成
        //             tbodyHtml = tbodyHtml + '<td id="' + getNextColumnId(tdPosition) + '" class="' + getIfHidden(hiddenColumns, columnName) + '">' + INSTANCES_INFO[outerArrayKey][columnName] + '</td>';
        //         }
        //         tbodyHtml = tbodyHtml + '</tr>';
        //         // 行の位置をインクリメント
        //         tdPosition.row++;
        //         // 列の位置をリセット
        //         tdPosition.column = 0;
        //     }
        //     // trの閉じタグを追加
        //     var tbodyHtml = tbodyHtml + '</tbody></tr>';
        //     document.getElementById('dynamicTable').insertAdjacentHTML(
        //         'beforeend', tbodyHtml);
        // }

        function getNextColumnId(tdPosition) {
            return tdPosition.row + ':' + ++tdPosition.column;
        }

        /**
         * キー名(第2引数)が配列（第1引数）に存在する場合は' hidden'の文字列を返す
         */
        function getIfHidden(hiddenColumns, targetKey) {
            // 存在しない場合 : 空文字を返す
            // 存在する場合 : ' hidden'を返す
            return (hiddenColumns.indexOf(targetKey) == -1) ? '' : ' hidden';
        }
    });

    /**
     * srcの読み込みを待ってからcallbackを実行する
     */
    function loadScript(src, callback) {
        var done = false;
        var head = document.getElementsByTagName('head')[0];
        var script = document.createElement('script');
        script.src = src;
        head.appendChild(script);
        // Attach handlers for all browsers
        script.onload = script.onreadystatechange = function() {
            if (!done && (!this.readyState ||
                    this.readyState === "loaded" || this.readyState === "complete")) {
                done = true;
                callback();
                // Handle memory leak in IE
                script.onload = script.onreadystatechange = null;
                if (head && script.parentNode) {
                    head.removeChild(script);
                }
            }
        };
    }

    /**
     * 指定されたキー名のローカルストレージを取得する
     * ※無い場合は空文字を返す
     */
    function getLocalStorageAsArray(storageKey) {
        var locStrgString = localStorage.getItem(storageKey);
        console.log('[getLocalStorageAsArray] ' + storageKey + ' : ' + locStrgString);
        // ローカルストレージに値が有る場合 : カンマ区切りで配列化して返す
        // ローカルストレージに値が無い場合 : 空文字で返す
        return (locStrgString) ? locStrgString.split(',') : [];
    }

    /**
     * 表示順決定用ローカルキー配列をローカルストレージより取得する
     */
    function getTableKeysForDispOrderArrayFromLocalStorage() {
        return getLocalStorageAsArray(STORAGE_KEY_HIDDEN_COULUMNS);
    }

    /**
     * 非表示カラム配列をローカルストレージより取得する
     */
    function getHiddenColumnsArrayFrmLocStrg() {
        return getLocalStorageAsArray(STORAGE_KEY_HIDDEN_COULUMNS);
    }

    /**
     * ログUtil
     */
    function logging(processName, message) {
        console.log('[' + processName + '] ' + message);
    }
    </script>
    <script type="text/javascript" src="js/movableColumn.js"></script>
    <script type="text/javascript" src="js/lightUpCross.js"></script>
    <script type="text/javascript" src="js/hideColumn.js"></script>
    <script type="text/javascript" src="js/menu.js"></script>
    <script type="text/javascript" src="js/menu_unvealCoulumn.js"></script>
</body>

</html>