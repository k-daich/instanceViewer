<!DOCTYPE html>
<html>

<head>
    <title>InstanceView</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <script type="text/javascript" src="js/data.js"></script> -->
    <link rel="stylesheet" type="text/css" href="css/movableColumn.css">
    <link rel="stylesheet" type="text/css" href="css/lightUpCross.css">
    <style>
        :root {
            --baseColor: #363636; /* this color is dynamic set by javascript */
            --baseColor_bg: #dddddd; /* this color is dynamic set by javascript */
            --rightUpColor: #e6b2c0; /* this color is dynamic set by javascript */
        }

        html {
            color: var(--baseColor);
            background: var(--baseColor_bg);
        }

        .tableCommon {
            border-collapse: separate;
            border-spacing: 3px;
            --nonFixedStartPos_x: 165px;
            --nonFixedStartPos_y: 8px;
            /*width: 100%;*/
        }

        /* 動的テーブルの子孫thタグのスタイル指定 */
        /* 動的テーブルの子孫tdタグのスタイル指定 */
        .tableCommon th,
        .tableCommon td {
            border-style: solid;
            border-radius: 3px;
            text-align: center;
            width: -moz-max-content;
            width: -webkit-max-content;
            width: max-content;
        }

        .fixedColumnTable {
            position : fixed;
            z-index:20;
        }

        .dynamicTable {
            position : absolute;
            top : var(--nonFixedStartPos_y);
            left : var(--nonFixedStartPos_x);
        }

        .oneColumnTable {
            position : absolute;
        }

        /* 動的テーブルの子孫thタグのスタイル指定 */
        .tableCommon th {
            position : fixed;
            z-index:20;
            top : var(--nonFixedStartPos_y);
            background-color: #c79852;
            color: white;
            border: solid 1px #927141;
            padding: 3px 0;
            font-size: 1.1rem;
            line-height: 1.2rem;
        }

        th.column1 {
            left : var(--column1_x);
            transition : 2s;
        }

        th.column2 {
            left : calc(var(--column1_x) + var(--column2_x));
            transition : 2s;
        }

        /* 動的テーブルの子孫trタグのスタイル指定 */
        .tableCommon tr {
            background-color: #e4d4bc;
        }
        /* 動的テーブルの子孫trタグのスタイル指定(偶数行) */
        .tableCommon tr:nth-of-type(2n) {
            background-color: #eaeae0;
        }

        /* 動的テーブルの子孫tdタグのスタイル指定 */
        .tableCommon td {
            border: solid 1px #af9d85;
            padding: 2px 10px;
            font-size: 0.9rem;
        }

        .icon-column {
            position: relative;
            width: 15px;
            height: 15px;
            background: #bbb;
            border-radius: 50%;
            text-align: center;
            margin: auto;
        }

        .icon-minus::before {
            position: absolute;
            top: calc(50% - 1px);
            left: 50%;
            content: '';
            display: inline-block;
            width: 60%;
            height: 10%;
            transform: translateX(-50%);
        }

        .icon-column.icon-minus::before {
            border-top: 2px solid #fff;
        }

        .icon-menu.icon-minus::before {
            border-top: 4px solid #333;
        }

        .icon-menu {
            position : fixed;
            width: 50px;
            height: 50px;
            right : 10px;
            bottom : 10px;
            background: #ccc;
            border-radius: 50%;
            margin: auto;
            border: 5px solid #333;
            z-index: 20;
        }

        .icon-plus::after {
            position: absolute;
            top: 50%;
            left: 50%;
            content: '';
            display: inline-block;
            width: 50%;
            height: 50%;
            border-top: 4px solid #333;
            transform: translateX(-50%);
        }

        .icon-plus:after {
            top: 25%;
            left: 0;
            transform: rotate(90deg);
        }

        .menu-window {
            position : fixed;
            right :20px;
            bottom :20px;
            width : 20vh;
            height : 150px;
            color : #fff;
            background: #000;
            border-radius: 7px;
            z-index: 10;
            transition : 1.2s;
        }

        .hidden, .hidden * {
            /*display: none;*/
            opacity : 0 !important;
            height : 5px !important;
            width : 0 !important;
            font-size : 0 !important;
            transition : 1.2s !important;
        }

    </style>
    <div id="style_writtenByJavascript">
    </div>
</head>

<body>
    <main>
        <div id="fixedColumnTable" class="tableCommon fixedColumnTable"></div>
        <div id="fixedTheadTable" class="tableCommon fixedTheadTable"></div>
        <div id="dynamicTable" class="tableCommon dynamicTable"></div>
        <div id="menu-button" class="icon-menu icon-plus icon-minus"></div>
        <div id="menu-window" class="menu-window hidden">
            <ul id="unvealColumnList">
            </ul>
        </div>
    </main>
    <script type="text/javascript">
    const JSFILE_DATA = "js/data.js";
    const JSFILE_MOVABLE_COLMN = "js/movableColumn.js";
    const JSFILE_LIGHTUP_CROSS = "js/lightUpCross.js";
    const JSFILE_HIDE_COLUMN = "js/hideColumn.js";
    const JSFILE_UNVEAL_COLUMN = "js/menu_unvealCoulumn.js";

    /* 定数定義 */
    const STORAGE_KEY_HIDDEN_COULUMNS = 'hiddenColumns';
    const STORAGE_KEY_TBL_KEYS_DISP_ORDER = 'tableKeysForDispOrder';

    // data.js読み込み完了後にdynamicTableを生成する
    loadScript(JSFILE_DATA, function() {
        var instancesInfo = buildDataAsObject();
        var tableKeysForDispOrder = decideTableKeysDispOrder();
        var hiddenColumns = getHiddenColumnsArrayFrmLocStrg();

        // createTableHeaderRowHtml(tableKeysForDispOrder, hiddenColumns);
        // createTableDataRowHtml(tableKeysForDispOrder, hiddenColumns);
        buildTable(instancesInfo, tableKeysForDispOrder, hiddenColumns);

        // dynamicTableにイベントリスナーを付与するため、必ずdynamicTable生成完了後に実施する必要がある
        loadScript(JSFILE_MOVABLE_COLMN, function() {
            // this function is in movableColumn.js
            moveColumnEventListenr();
        });

        // dynamicTableにイベントリスナーを付与するため、必ずdynamicTable生成完了後に実施する必要がある
        loadScript(JSFILE_LIGHTUP_CROSS, function() {
            // this function is in lightUpCross.js
            lightUpCrossEventListener();
        });

        // dynamicTableにイベントリスナーを付与するため、必ずdynamicTable生成完了後に実施する必要がある
        loadScript(JSFILE_HIDE_COLUMN, function() {
            // this function is in hideColumn.js
            hideColumnEventListener();
        });

        /**
         * data.jsからオブジェクトを構築する
         */
        function buildDataAsObject() {
            var firstTimeFlg = true;
            var instancesInfo = new Object();
            instancesInfo.instanceNames = [];
            Object.keys(INSTANCES_INFO).map(
                key => {
                    if (firstTimeFlg) {
                        firstTimeFlg = false;
                        instancesInfo.columnNames = Object.keys(INSTANCES_INFO[key]);
                    }
                    instancesInfo.instanceNames.push(key);
                    instancesInfo[key] = buildInstanceAsObject(key, INSTANCES_INFO[key]);
                }
            );
            loggingObj("instancesInfo", instancesInfo);
            return instancesInfo;
        }

        function buildInstanceAsObject(instanceName, associativeArray_depth2) {
            var instance = new Object();
            instance.instanceName = instanceName;
            Object.keys(associativeArray_depth2).forEach(key =>
                instance[key] = associativeArray_depth2[key]
            );
            loggingObj(instance.instanceName, instance);
            return instance;
        }

        /**
         * 
         */
        function decideTableKeysDispOrder() {
            var locStrgArray = getTableKeysForDispOrderArrayFrmLocalStorage();

            // localStorageの値が妥当な場合
            if (isCorrectTableKeys(locStrgArray)) {
                // ローカルストレージの値を返す
                return locStrgArray;
            }
            // localStorageの値が妥当でない場合
            else {
                // 現在のデータ値からキー値を取得する
                var tableKeysForDispOrder_current = Object.keys(INSTANCES_INFO[Object.keys(INSTANCES_INFO)[0]]);
                // ローカルストレージを更新する
                localStorage.setItem(STORAGE_KEY_TBL_KEYS_DISP_ORDER, tableKeysForDispOrder_current);
                return tableKeysForDispOrder_current;
            }
        }

        /**
         * テーブルキー配列が妥当か現在の値を元に判定する
         */
        function isCorrectTableKeys(tableKeysForDispOrder) {
            // 現在のキー配列を取得する
            var currentKeys = INSTANCES_INFO[Object.keys(INSTANCES_INFO)[0]];
            // 妥当と判定した回数
            var correctCount = 0;

            // ローカルストレージから取得した配列を元に繰り返し処理
            for (index in tableKeysForDispOrder) {
                // ローカルストレージのキー値が現在のキー配列に存在する場合
                if (tableKeysForDispOrder[index] in currentKeys) {
                    // チェック状態管理用フラグを1つ立てる
                    ++correctCount;
                } else {
                    console.log('[isCorrectTableKeys] false : A');
                    return false;
                }
            }
            // 妥当と判定した回数が現在のキー配列長と一致しない場合
            if (Object.keys(currentKeys).length != correctCount) {
                console.log('[isCorrectTableKeys] false : B');
                return false;
            }
            console.log('[isCorrectTableKeys] true');
            return true;
        }

        function buildTable(instancesInfo, tableKeysForDispOrder, hiddenColumns) {
            var column_index = 0;
            buildFixedColumnTable(instancesInfo);
            instancesInfo.columnNames.map(columnName => buildDynamicColumnTable(column_index++, columnName));
        }

        function buildFixedColumnTable(instancesInfo) {
            var tableHtml = '<table><thead><tr><th>No</th><th>インスタンス名</th></tr></thead><tbody>';
            var no = 1;

            instancesInfo.instanceNames.map(
                instanceName => {
                    logging('instanceNames', instanceName);
                    tableHtml = tableHtml + '<tr><td>' + no++ + '</td><td>' + instanceName + '</td></tr>';
                }
            );

            tableHtml = tableHtml + '</tbody></table>';
            document.getElementById('fixedColumnTable').insertAdjacentHTML('beforeend', tableHtml);
        }

        function buildDynamicColumnTable(column_index, columnName) {
            var targetId = 'columnTableX_' + column_index;
            var tableHtml = '<table id="' + targetId + '" class="oneColumnTable ' + targetId + '"><thead><tr><th>' + columnName + '</th></tr></thead><tbody>';
            var instanceNames = Object.keys(INSTANCES_INFO);

            for (index in instanceNames) {
                tableHtml = tableHtml + '<tr><td>' + getInstanceInfo(instanceNames[index], columnName) + '</td></tr>';
            }

            tableHtml = tableHtml + '</tbody></table>';
            document.getElementById('dynamicTable').insertAdjacentHTML('beforeend', tableHtml);
            calcColumnPosition(column_index, document.getElementById(targetId).scrollWidth);
        }

        function getNextColumnId(tdPosition) {
            return tdPosition.row + ':' + ++tdPosition.column;
        }

        /**
         * キー名(第2引数)が配列（第1引数）に存在する場合は' hidden'の文字列を返す
         */
        function getIfHidden(hiddenColumns, targetKey) {
            // 存在しない場合 : 空文字を返す
            // 存在する場合 : ' hidden'を返す
            return (hiddenColumns.indexOf(targetKey) == -1) ? '' : ' hidden';
        }

        function calcColumnPosition(column_index, column_width) {
            var target_id = 'columnTableX_' + column_index;
            var target_style_id = target_id + '_style';

            var leftPositionFormula = 'width : calc( var(--nonFixedStartPos_x) + ';

            for (var i = 0; i <= column_index; i++, leftPositionFormula = leftPositionFormula + ' + ') {
                leftPositionFormula = leftPositionFormula + 'var(--columnWidth_' + i + ')'
            }

            if (!document.getElementById(target_style_id)) {
                logging('calc insert', '<style id="' + target_style_id + '"> .' + target_id + ' { ' + leftPositionFormula + ')!important;transition: 0.7s;} </style>');
                document.getElementById("style_writtenByJavascript").insertAdjacentHTML('beforeend',
                    '<style id="' + target_style_id + '"> #' + target_id + ' { ' + leftPositionFormula + ')!important;transition: 0.7s;} </style>');
                document.documentElement.style.setProperty('--columnWidth_' + column_index, column_width);
            } else {
                logging('calc update', '<style id="' + target_id + '"> .' + target_id + ' { ' + leftPositionFormula + ')!important;transition: 0.7s;} </style>');
                document.getElementById(target_id).innerHtml =
                    '<style id="' + target_style_id + '"> #' + target_id + ' { ' + leftPositionFormula + ')!important;transition: 0.7s;} </style>';
                document.documentElement.style.setProperty('--columnWidth_' + column_index, column_width + 100);
            }
        }
    });

    /**
     * srcの読み込みを待ってからcallbackを実行する
     */
    function loadScript(src, callback) {
        var done = false;
        var head = document.getElementsByTagName('head')[0];
        var script = document.createElement('script');
        script.src = src;
        head.appendChild(script);
        // Attach handlers for all browsers
        script.onload = script.onreadystatechange = function() {
            if (!done && (!this.readyState ||
                    this.readyState === "loaded" || this.readyState === "complete")) {
                done = true;
                callback();
                // Handle memory leak in IE
                script.onload = script.onreadystatechange = null;
                if (head && script.parentNode) {
                    head.removeChild(script);
                }
            }
        };
    }

    /**
     * 指定されたキー名のローカルストレージを取得する
     * ※無い場合は空文字を返す
     */
    function getLocalStorageAsArray(storageKey) {
        var locStrgString = localStorage.getItem(storageKey);
        console.log('[getLocalStorageAsArray] ' + storageKey + ' : ' + locStrgString);
        // ローカルストレージに値が有る場合 : カンマ区切りで配列化して返す
        // ローカルストレージに値が無い場合 : 空文字で返す
        return (locStrgString) ? locStrgString.split(',') : [];
    }

    /**
     * インスタンス名の配列を返す
     */
    function getInstanceNames() {
        return Object.keys(INSTANCES_INFO).split(',');
    }

    /**
     * 表示順決定用ローカルキー配列をローカルストレージより取得する
     */
    function getInstanceInfo(instanceName, columnName) {
        return INSTANCES_INFO[instanceName][columnName];
    }

    /**
     * 表示順決定用ローカルキー配列をローカルストレージより取得する
     */
    function getTableKeysForDispOrderArrayFrmLocalStorage() {
        return getLocalStorageAsArray(STORAGE_KEY_TBL_KEYS_DISP_ORDER);
    }

    /**
     * 非表示カラム配列をローカルストレージより取得する
     */
    function getHiddenColumnsArrayFrmLocStrg() {
        return getLocalStorageAsArray(STORAGE_KEY_HIDDEN_COULUMNS);
    }

    /**
     * ログUtil
     */
    function logging(processName, message) {
        console.log('[' + processName + '] ' + message);
    }

    /**
     * ログUtil(オブジェクトの内容出力)
     */
    function loggingObj(processName, object) {
        console.log('[' + processName + '] ');
        console.dir(object);
    }
    </script>
    <script type="text/javascript" src="js/movableColumn.js"></script>
    <script type="text/javascript" src="js/lightUpCross.js"></script>
    <script type="text/javascript" src="js/hideColumn.js"></script>
    <script type="text/javascript" src="js/menu.js"></script>
    <script type="text/javascript" src="js/menu_unvealCoulumn.js"></script>
</body>

</html>